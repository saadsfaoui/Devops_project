<div class="overlay" *ngIf="isOpen" (click)="onClose()"></div>
<div class="panel" *ngIf="isOpen">
  <button class="close-btn" (click)="onClose()">âœ•</button>

  <!-- HEADER CARD -->
  <div class="card-header" [style.background-image]="'url(' + location.imageUrl + ')'">
    <a class="compare-btn" [routerLink]="['/comparateur']" [queryParams]="{city: location.name}" title="Comparer">
      â†”
    </a>
    <button 
      class="favourite-btn" 
      (click)="toggleFavourite($event)"
      [disabled]="isTogglingFavourite()"
      [class.is-favourite]="isFavourite()"
      [title]="isFavourite() ? 'Remove from favourites' : 'Add to favourites'"
    >
      <svg width="24" height="24" viewBox="0 0 24 24" [attr.fill]="isFavourite() ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
      </svg>
    </button>
    <div class="city-title">{{ location.name }}</div>
    <div class="city-subtitle">{{ location.country }} Â· {{ location.date }} Â· {{ location.time }}</div>
    
    <!-- Rating Section -->
    <div class="rating-container" *ngIf="isFavourite()" (click)="$event.stopPropagation()">
      <div class="rating-stars">
        <button 
          *ngFor="let star of getRatingArray()" 
          class="star-button"
          [class.filled]="currentRating() && star <= currentRating()!"
          [class.empty]="!currentRating() || star > currentRating()!"
          [disabled]="isUpdatingRating()"
          (click)="updateRating(star, $event)"
          title="Rate {{ star }} star{{ star > 1 ? 's' : '' }}"
        >
          â˜…
        </button>
      </div>
      <span class="rating-label" *ngIf="currentRating()">{{ currentRating() }}/5</span>
      <span class="rating-label no-rating" *ngIf="!currentRating()">Rate this city</span>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div 
      *ngFor="let tab of tabs" 
      class="tab"
      [class.active]="activeTab === tab.value"
      (click)="onTabClick(tab.value)">
      <span class="tab-icon">{{ tab.icon }}</span>
      <span class="tab-label">{{ tab.label }}</span>
    </div>
  </div>

  <!-- CONTENT SECTIONS -->
  <div class="content">
    <!-- Bike Section -->
    <div *ngIf="activeTab === 'bike'" class="section">
      <div class="bike-section" *ngIf="location.bikeData">
        <div class="bike-icon">ðŸš²</div>
        <div class="status">{{ location.bikeData.status || 'Available' }}</div>
        <div class="subtext">{{ location.bikeData.available || 0 }} bikes available at nearby stations</div>
        <div class="highlight-box">
          Closest station: {{ location.bikeData.closestStation || 'Unknown' }} ({{ location.bikeData.walkTime || '5 min' }} walk)
        </div>
      </div>
      <div *ngIf="!location.bikeData" class="section">
        <p>No bike data available</p>
      </div>
    </div>

    <!-- Weather Section -->
    <div *ngIf="activeTab === 'weather'" class="section">
      <div class="info-section" *ngIf="location.weatherData">
        <div class="weather-header">
          <img 
            *ngIf="location.weatherData.current?.condition?.icon" 
            [src]="'https:' + location.weatherData.current.condition.icon" 
            alt="Weather icon"
            class="weather-icon">
          <div class="weather-main">
            <h3>{{ location.weatherData.current?.condition?.text || 'Unknown' }}</h3>
            <p class="temperature">{{ location.weatherData.current?.temp_c || 'â€”' }}Â°C</p>
          </div>
        </div>
        <div class="weather-grid">
          <div>
            <p class="label">Feels Like</p>
            <p class="value">{{ location.weatherData.current?.feelslike_c || 'â€”' }}Â°C</p>
          </div>
          <div>
            <p class="label">Humidity</p>
            <p class="value">{{ location.weatherData.current?.humidity || 'â€”' }}%</p>
          </div>
          <div>
            <p class="label">Wind Speed</p>
            <p class="value">{{ location.weatherData.current?.wind_kph || 'â€”' }} km/h</p>
          </div>
          <div>
            <p class="label">Wind Direction</p>
            <p class="value">{{ location.weatherData.current?.wind_dir || 'â€”' }}</p>
          </div>
          <div>
            <p class="label">Visibility</p>
            <p class="value">{{ location.weatherData.current?.vis_km || 'â€”' }} km</p>
          </div>
          <div>
            <p class="label">Timezone</p>
            <p class="value">{{ location.weatherData.location?.tz_id || 'â€”' }}</p>
          </div>
        </div>
      </div>
      <div *ngIf="!location.weatherData" class="info-section">
        <p>Weather data loading...</p>
      </div>
    </div>

    <!-- Culture Section -->
    <div *ngIf="activeTab === 'culture'" class="section">
      <div class="info-section">
        <h3>Cultural Information</h3>
        <p>Cultural details coming soon...</p>
      </div>
    </div>

    <!-- Music Section -->
    <div *ngIf="activeTab === 'music'" class="section">
      <div class="info-section">
        <h3>Music & Events</h3>
        <p>Music information coming soon...</p>
      </div>
    </div>

    <!-- Pollution Section -->
    <div *ngIf="activeTab === 'pollution'" class="section">
      <div class="info-section" *ngIf="location.pollutionData">
        <div class="pollution-header">
          <img 
            src="/airQuality.png" 
            alt="Air quality icon"
            class="pollution-icon">
          <div class="pollution-main">
            <h3>Air Quality Index</h3>
            <p class="aqi-value">{{ location.pollutionData.aqi || 'â€”' }}</p>
          </div>
        </div>
        <div class="pollution-grid">
          <div>
            <p class="label">PM2.5</p>
            <p class="value">{{ location.pollutionData.pm25 || 'â€”' }}</p>
          </div>
          <div>
            <p class="label">PM10</p>
            <p class="value">{{ location.pollutionData.pm10 || 'â€”' }}</p>
          </div>
          <div>
            <p class="label">NOâ‚‚</p>
            <p class="value">{{ location.pollutionData.no2 || 'â€”' }}</p>
          </div>
          <div>
            <p class="label">CO</p>
            <p class="value">{{ location.pollutionData.co || 'â€”' }}</p>
          </div>
          <div>
            <p class="label">Oâ‚ƒ</p>
            <p class="value">{{ location.pollutionData.o3 || 'â€”' }}</p>
          </div>
          <div>
            <p class="label">Dominant</p>
            <p class="value">{{ location.pollutionData.dominentpol || 'â€”' }}</p>
          </div>
        </div>
      </div>
      <div *ngIf="!location.pollutionData" class="info-section">
        <p>Pollution data not available</p>
      </div>
    </div>
  </div>
</div>
